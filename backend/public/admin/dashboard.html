<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - VitaFit</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar h1 { font-size: 24px; }
        .navbar .user-info { display: flex; align-items: center; gap: 15px; }
        .btn-logout {
            background: rgba(255,255,255,0.2); border: 1px solid white;
            color: white; padding: 8px 20px; border-radius: 20px; cursor: pointer;
        }
        .btn-logout:hover { background: white; color: #667eea; }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.3s;
            position: relative; overflow: hidden;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .number { font-size: 32px; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .stat-card .subtitle { font-size: 12px; color: #999; }
        .stat-card .icon {
            position: absolute; top: 20px; left: 20px;
            font-size: 40px; opacity: 0.2;
        }
        .stat-card.orders { border-right: 4px solid #ffc107; }
        .stat-card.revenue { border-right: 4px solid #28a745; }
        .stat-card.products { border-right: 4px solid #17a2b8; }
        .stat-card.users { border-right: 4px solid #6f42c1; }

        .section {
            background: white; border-radius: 15px; padding: 25px;
            margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #333; margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 2px solid #667eea; display: flex;
            justify-content: space-between; align-items: center;
        }
        .section h2 a { font-size: 14px; color: #667eea; text-decoration: none; }

        .quick-actions {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 12px;
            text-align: center; cursor: pointer; transition: transform 0.2s;
            text-decoration: none; display: block;
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .action-btn .icon { font-size: 28px; margin-bottom: 10px; display: block; }
        .action-btn span { font-weight: 600; }

        table { width: 100%; border-collapse: collapse; }
        table th {
            background: #f8f9fa; padding: 12px; text-align: right;
            font-weight: 600; color: #333; border-bottom: 2px solid #dee2e6;
        }
        table td { padding: 12px; border-bottom: 1px solid #dee2e6; }
        table tr:hover { background: #f8f9fa; }

        .badge {
            display: inline-block; padding: 4px 12px; border-radius: 12px;
            font-size: 12px; font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }

        .loading { text-align: center; padding: 40px; color: #666; }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 992px) { .row { grid-template-columns: 1fr; } }

        .chart-placeholder {
            height: 200px; background: #f8f9fa; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: #999;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>VitaFit - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
        <div class="user-info">
            <span id="userName">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</span>
            <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </nav>

    <div class="container">
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card orders">
                <div class="icon">ğŸ“¦</div>
                <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                <div class="number" id="todayOrders">0</div>
                <div class="subtitle"><span id="pendingOrders">0</span> Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚</div>
            </div>
            <div class="stat-card revenue">
                <div class="icon">ğŸ’°</div>
                <h3>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                <div class="number" id="todayRevenue">0</div>
                <div class="subtitle">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</div>
            </div>
            <div class="stat-card products">
                <div class="icon">ğŸ›ï¸</div>
                <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                <div class="number" id="totalProducts">0</div>
                <div class="subtitle"><span id="lowStock">0</span> Ù…Ù†Ø®ÙØ¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
            </div>
            <div class="stat-card users">
                <div class="icon">ğŸ‘¥</div>
                <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                <div class="number" id="totalUsers">0</div>
                <div class="subtitle"><span id="newUsers">0</span> Ø¬Ø¯ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="section">
            <h2>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h2>
            <div class="quick-actions">
                <a href="products" class="action-btn">
                    <span class="icon">ğŸ›ï¸</span>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                </a>
                <a href="orders" class="action-btn">
                    <span class="icon">ğŸ“¦</span>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                </a>
                <a href="users" class="action-btn">
                    <span class="icon">ğŸ‘¥</span>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                </a>
                <a href="subscriptions" class="action-btn">
                    <span class="icon">â­</span>
                    <span>Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</span>
                </a>
                <a href="trainers" class="action-btn">
                    <span class="icon">ğŸ†</span>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†</span>
                </a>
                <a href="workshops" class="action-btn">
                    <span class="icon">ğŸ“š</span>
                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ø´</span>
                </a>
            </div>
        </div>

        <div class="row">
            <!-- Recent Orders -->
            <div class="section">
                <h2>
                    Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                    <a href="orders">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ â†</a>
                </h2>
                <div id="recentOrders" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>

            <!-- Recent Users -->
            <div class="section">
                <h2>
                    Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
                    <a href="users">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ â†</a>
                </h2>
                <div id="recentUsers" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>

        <!-- Low Stock Products -->
        <div class="section">
            <h2>
                Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                <a href="products">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ â†</a>
            </h2>
            <div id="lowStockProducts" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let token = localStorage.getItem('adminToken');

        if (!token) {
            window.location.href = 'index';
        }

        const user = JSON.parse(localStorage.getItem('adminUser') || '{}');
        document.getElementById('userName').textContent = user.name || 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„';

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = 'index';
        }

        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_URL}/api${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                return await response.json();
            } catch (error) {
                console.error('Error fetching:', endpoint, error);
                return { success: false };
            }
        }

        function getStatusBadge(status) {
            const map = {
                'pending': { class: 'badge-warning', text: 'Ù…Ø¹Ù„Ù‚' },
                'confirmed': { class: 'badge-info', text: 'Ù…Ø¤ÙƒØ¯' },
                'shipped': { class: 'badge-info', text: 'Ù‚ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†' },
                'delivered': { class: 'badge-success', text: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' },
                'cancelled': { class: 'badge-danger', text: 'Ù…Ù„ØºÙŠ' }
            };
            const s = map[status] || { class: 'badge-warning', text: status };
            return `<span class="badge ${s.class}">${s.text}</span>`;
        }

        async function loadDashboard() {
            // Load Orders Stats
            const ordersData = await fetchData('/orders/admin/all?limit=100');
            if (ordersData.success) {
                const orders = ordersData.data || [];
                const today = new Date().toDateString();

                const todayOrders = orders.filter(o =>
                    new Date(o.created_at).toDateString() === today
                );

                document.getElementById('todayOrders').textContent = todayOrders.length;
                document.getElementById('pendingOrders').textContent =
                    orders.filter(o => o.status === 'pending').length;

                const todayRevenue = todayOrders
                    .filter(o => o.payment_status === 'paid')
                    .reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
                document.getElementById('todayRevenue').textContent = todayRevenue.toFixed(0);

                // Recent Orders
                displayRecentOrders(orders.slice(0, 5));
            }

            // Load Products
            const productsData = await fetchData('/products?limit=100');
            if (productsData.success) {
                const products = productsData.data || [];
                document.getElementById('totalProducts').textContent = products.length;

                const lowStock = products.filter(p => p.quantity <= 5 && p.quantity > 0);
                document.getElementById('lowStock').textContent = lowStock.length;

                displayLowStockProducts(lowStock.slice(0, 5));
            }

            // Load Users
            const usersData = await fetchData('/admin/users');
            if (usersData.success) {
                const users = usersData.data || [];
                document.getElementById('totalUsers').textContent = users.length;

                const thisMonth = new Date();
                thisMonth.setDate(1);
                const newUsers = users.filter(u =>
                    new Date(u.created_at) >= thisMonth
                );
                document.getElementById('newUsers').textContent = newUsers.length;

                displayRecentUsers(users.slice(0, 5));
            }
        }

        function displayRecentOrders(orders) {
            if (orders.length === 0) {
                document.getElementById('recentOrders').innerHTML =
                    '<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
                return;
            }

            document.getElementById('recentOrders').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => `
                            <tr>
                                <td><strong>${order.order_number}</strong></td>
                                <td>${order.shipping_name || order.user?.name || '-'}</td>
                                <td>${parseFloat(order.total).toFixed(2)} Ø±.Ø³</td>
                                <td>${getStatusBadge(order.status)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function displayRecentUsers(users) {
            if (users.length === 0) {
                document.getElementById('recentUsers').innerHTML =
                    '<p style="text-align: center; color: #999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>';
                return;
            }

            document.getElementById('recentUsers').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.name || '-'}</td>
                                <td>${user.email}</td>
                                <td>${new Date(user.created_at).toLocaleDateString('ar')}</td>
                                <td>${user.is_active
                                    ? '<span class="badge badge-success">Ù†Ø´Ø·</span>'
                                    : '<span class="badge badge-danger">ØºÙŠØ± Ù†Ø´Ø·</span>'
                                }</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function displayLowStockProducts(products) {
            if (products.length === 0) {
                document.getElementById('lowStockProducts').innerHTML =
                    '<p style="text-align: center; color: #999; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</p>';
                return;
            }

            document.getElementById('lowStockProducts').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr>
                                <td><strong>${product.name_ar || product.name}</strong></td>
                                <td>${product.price} Ø±.Ø³</td>
                                <td>${product.quantity}</td>
                                <td>
                                    ${product.quantity <= 0
                                        ? '<span class="badge badge-danger">Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>'
                                        : '<span class="badge badge-warning">Ù…Ù†Ø®ÙØ¶</span>'
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Load dashboard on page load
        loadDashboard();

        // Auto refresh every 5 minutes
        setInterval(loadDashboard, 300000);
    </script>
</body>
</html>
