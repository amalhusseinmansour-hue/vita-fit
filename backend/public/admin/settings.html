<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الإعدادات - لوحة التحكم</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --background: #0F172A;
            --surface: #1E293B;
            --surface-light: #334155;
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --border: #475569;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .sidebar {
            background: var(--surface);
            min-height: 100vh;
            padding: 20px 0;
            position: fixed;
            width: 250px;
            border-left: 1px solid var(--border);
        }

        .sidebar .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .sidebar .logo h4 {
            color: var(--primary);
            margin: 0;
        }

        .sidebar .nav-link {
            color: var(--text-secondary);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: var(--surface-light);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .main-content {
            margin-right: 250px;
            padding: 30px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .card-header {
            background: var(--surface-light);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
            border-radius: 12px 12px 0 0 !important;
        }

        .card-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 20px;
        }

        .form-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            background: var(--background);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
        }

        .form-control:focus, .form-select:focus {
            background: var(--background);
            border-color: var(--primary);
            color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
        }

        .form-check-input {
            background-color: var(--background);
            border-color: var(--border);
        }

        .form-check-input:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .form-switch .form-check-input {
            width: 48px;
            height: 24px;
        }

        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
            padding: 10px 24px;
            border-radius: 8px;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-success {
            background: var(--secondary);
            border-color: var(--secondary);
        }

        .btn-outline-secondary {
            color: var(--text-secondary);
            border-color: var(--border);
        }

        .btn-outline-secondary:hover {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .nav-tabs {
            border-bottom: 1px solid var(--border);
        }

        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border: none;
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
        }

        .nav-tabs .nav-link:hover {
            color: var(--text-primary);
            border-color: transparent;
        }

        .nav-tabs .nav-link.active {
            background: var(--surface);
            color: var(--primary);
            border: 1px solid var(--border);
            border-bottom-color: var(--surface);
        }

        .setting-group {
            background: var(--background);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .setting-group-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group-text {
            background: var(--surface-light);
            border-color: var(--border);
            color: var(--text-secondary);
        }

        .alert {
            border-radius: 8px;
            border: none;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        .badge-enabled {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .badge-disabled {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .payment-card {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .payment-card.enabled {
            border-color: var(--success);
        }

        .payment-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .payment-logo {
            height: 40px;
            object-fit: contain;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h4><i class="bi bi-heart-pulse-fill"></i> VitaFit</h4>
        </div>
        <nav>
            <a href="dashboard" class="nav-link"><i class="bi bi-speedometer2"></i> لوحة التحكم</a>
            <a href="products" class="nav-link"><i class="bi bi-box-seam"></i> المنتجات</a>
            <a href="orders" class="nav-link"><i class="bi bi-cart3"></i> الطلبات</a>
            <a href="users" class="nav-link"><i class="bi bi-people"></i> المستخدمين</a>
            <a href="subscriptions" class="nav-link"><i class="bi bi-credit-card"></i> الاشتراكات</a>
            <a href="trainers" class="nav-link"><i class="bi bi-person-badge"></i> المدربين</a>
            <a href="workshops" class="nav-link"><i class="bi bi-calendar-event"></i> ورش العمل</a>
            <a href="settings" class="nav-link active"><i class="bi bi-gear"></i> الإعدادات</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-gear me-2"></i>الإعدادات</h2>
                <p class="text-secondary mb-0">إدارة إعدادات التطبيق والدفع</p>
            </div>
            <button class="btn btn-primary" onclick="saveAllSettings()">
                <i class="bi bi-check2-circle me-2"></i>حفظ جميع التغييرات
            </button>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Settings Tabs -->
        <ul class="nav nav-tabs mb-4" id="settingsTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#general">
                    <i class="bi bi-sliders me-2"></i>الإعدادات العامة
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#payment">
                    <i class="bi bi-credit-card me-2"></i>إعدادات الدفع
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#shipping">
                    <i class="bi bi-truck me-2"></i>الشحن والضرائب
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#notifications">
                    <i class="bi bi-bell me-2"></i>الإشعارات
                </a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- General Settings -->
            <div class="tab-pane fade show active" id="general">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-building"></i> معلومات التطبيق</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اسم التطبيق</label>
                                <input type="text" class="form-control" id="appName" value="VitaFit">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اسم التطبيق (عربي)</label>
                                <input type="text" class="form-control" id="appNameAr" value="فيتا فت">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">البريد الإلكتروني للدعم</label>
                                <input type="email" class="form-control" id="supportEmail" value="support@vitafit.online">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">رقم هاتف الدعم</label>
                                <input type="tel" class="form-control" id="supportPhone" value="+971501234567">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">العملة الافتراضية</label>
                                <select class="form-select" id="defaultCurrency">
                                    <option value="AED">درهم إماراتي (AED)</option>
                                    <option value="SAR">ريال سعودي (SAR)</option>
                                    <option value="KWD">دينار كويتي (KWD)</option>
                                    <option value="QAR">ريال قطري (QAR)</option>
                                    <option value="BHD">دينار بحريني (BHD)</option>
                                    <option value="OMR">ريال عماني (OMR)</option>
                                    <option value="EGP">جنيه مصري (EGP)</option>
                                    <option value="JOD">دينار أردني (JOD)</option>
                                    <option value="USD">دولار أمريكي (USD)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">رابط الموقع</label>
                                <input type="url" class="form-control" id="websiteUrl" value="https://vitafit.online">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-shop"></i> إعدادات المتجر</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="storeEnabled" checked>
                                    <label class="form-check-label" for="storeEnabled">تفعيل المتجر</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="allowGuestCheckout">
                                    <label class="form-check-label" for="allowGuestCheckout">السماح بالشراء بدون تسجيل</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الحد الأدنى للطلب</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="minOrderAmount" value="50">
                                    <span class="input-group-text">AED</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">حد التنبيه للمخزون المنخفض</label>
                                <input type="number" class="form-control" id="lowStockThreshold" value="5">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Settings -->
            <div class="tab-pane fade" id="payment">
                <!-- PayMob -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-credit-card-2-front"></i> PayMob - بوابة الدفع</h5>
                            <span id="paymobStatus" class="badge-disabled">معطل</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            للحصول على بيانات PayMob، قم بالتسجيل في
                            <a href="https://accept.paymob.com" target="_blank">accept.paymob.com</a>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="paymobEnabled" onchange="updatePaymobStatus()">
                                    <label class="form-check-label" for="paymobEnabled">تفعيل PayMob</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="paymobProduction">
                                    <label class="form-check-label" for="paymobProduction">وضع الإنتاج (Production)</label>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <div class="setting-group-title">بيانات API</div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">API Key</label>
                                    <input type="password" class="form-control" id="paymobApiKey" placeholder="أدخل API Key">
                                    <small class="text-secondary">يمكنك الحصول عليه من لوحة تحكم PayMob</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Integration ID</label>
                                    <input type="text" class="form-control" id="paymobIntegrationId" placeholder="أدخل Integration ID">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Iframe ID</label>
                                    <input type="text" class="form-control" id="paymobIframeId" placeholder="أدخل Iframe ID">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">HMAC Secret</label>
                                    <input type="password" class="form-control" id="paymobHmacSecret" placeholder="أدخل HMAC Secret">
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-success" onclick="testPaymobConnection()">
                            <i class="bi bi-check-circle me-2"></i>اختبار الاتصال
                        </button>
                    </div>
                </div>

                <!-- Google Pay -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-google"></i> Google Pay</h5>
                            <span id="googlePayStatus" class="badge-disabled">معطل</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="googlePayEnabled" onchange="updateGooglePayStatus()">
                                    <label class="form-check-label" for="googlePayEnabled">تفعيل Google Pay</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="googlePayProduction">
                                    <label class="form-check-label" for="googlePayProduction">وضع الإنتاج</label>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <div class="setting-group-title">بيانات التاجر</div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Merchant ID</label>
                                    <input type="text" class="form-control" id="googlePayMerchantId" placeholder="أدخل Merchant ID">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Merchant Name</label>
                                    <input type="text" class="form-control" id="googlePayMerchantName" value="VitaFit">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Gateway Merchant ID</label>
                                    <input type="text" class="form-control" id="googlePayGatewayMerchantId" placeholder="من PayMob">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Apple Pay -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-apple"></i> Apple Pay</h5>
                            <span id="applePayStatus" class="badge-disabled">معطل</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="applePayEnabled" onchange="updateApplePayStatus()">
                                    <label class="form-check-label" for="applePayEnabled">تفعيل Apple Pay</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="applePayProduction">
                                    <label class="form-check-label" for="applePayProduction">وضع الإنتاج</label>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <div class="setting-group-title">بيانات التاجر</div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Merchant Identifier</label>
                                    <input type="text" class="form-control" id="applePayMerchantId" placeholder="merchant.com.vitafit">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Display Name</label>
                                    <input type="text" class="form-control" id="applePayMerchantName" value="VitaFit">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cash on Delivery -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-cash"></i> الدفع عند الاستلام</h5>
                            <span id="codStatus" class="badge-enabled">مفعل</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="codEnabled" checked onchange="updateCodStatus()">
                                    <label class="form-check-label" for="codEnabled">تفعيل الدفع عند الاستلام</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">رسوم إضافية للدفع عند الاستلام</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="codFee" value="0">
                                    <span class="input-group-text">AED</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shipping Settings -->
            <div class="tab-pane fade" id="shipping">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-truck"></i> إعدادات الشحن</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="freeShippingEnabled" checked>
                                    <label class="form-check-label" for="freeShippingEnabled">تفعيل الشحن المجاني</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الحد الأدنى للشحن المجاني</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="freeShippingMinimum" value="200">
                                    <span class="input-group-text">AED</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">تكلفة الشحن الافتراضية</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="defaultShippingCost" value="15">
                                    <span class="input-group-text">AED</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">مدة التوصيل المتوقعة</label>
                                <input type="text" class="form-control" id="estimatedDelivery" value="2-4 أيام عمل">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-percent"></i> إعدادات الضرائب</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="taxEnabled" checked>
                                    <label class="form-check-label" for="taxEnabled">تفعيل الضريبة</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">نسبة الضريبة (VAT)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="taxRate" value="5" step="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">رقم التسجيل الضريبي (TRN)</label>
                                <input type="text" class="form-control" id="taxNumber" placeholder="100xxxxxxxxx">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Settings -->
            <div class="tab-pane fade" id="notifications">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-bell"></i> إعدادات الإشعارات</h5>
                    </div>
                    <div class="card-body">
                        <div class="setting-group">
                            <div class="setting-group-title">إشعارات الطلبات</div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="notifyNewOrder" checked>
                                        <label class="form-check-label" for="notifyNewOrder">إشعار عند طلب جديد</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="notifyOrderStatus" checked>
                                        <label class="form-check-label" for="notifyOrderStatus">إشعار تحديث حالة الطلب</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <div class="setting-group-title">إشعارات المخزون</div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="notifyLowStock" checked>
                                        <label class="form-check-label" for="notifyLowStock">إشعار المخزون المنخفض</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="notifyOutOfStock" checked>
                                        <label class="form-check-label" for="notifyOutOfStock">إشعار نفاد المخزون</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <div class="setting-group-title">البريد الإلكتروني للإشعارات</div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">البريد الإلكتروني للأدمن</label>
                                    <input type="email" class="form-control" id="adminEmail" value="admin@vitafit.online">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        let authToken = localStorage.getItem('token');

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!authToken) {
                window.location.href = 'index';
                return;
            }
            loadSettings();
        });

        async function loadSettings() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        populateSettings(result.data);
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            } finally {
                hideLoading();
            }
        }

        function populateSettings(settings) {
            // General Settings
            if (settings.appName) document.getElementById('appName').value = settings.appName;
            if (settings.appNameAr) document.getElementById('appNameAr').value = settings.appNameAr;
            if (settings.supportEmail) document.getElementById('supportEmail').value = settings.supportEmail;
            if (settings.supportPhone) document.getElementById('supportPhone').value = settings.supportPhone;
            if (settings.defaultCurrency) document.getElementById('defaultCurrency').value = settings.defaultCurrency;
            if (settings.websiteUrl) document.getElementById('websiteUrl').value = settings.websiteUrl;

            // Store Settings
            if (settings.storeEnabled !== undefined) document.getElementById('storeEnabled').checked = settings.storeEnabled === true || settings.storeEnabled === 'true';
            if (settings.allowGuestCheckout !== undefined) document.getElementById('allowGuestCheckout').checked = settings.allowGuestCheckout === true || settings.allowGuestCheckout === 'true';
            if (settings.minOrderAmount) document.getElementById('minOrderAmount').value = settings.minOrderAmount;
            if (settings.lowStockThreshold) document.getElementById('lowStockThreshold').value = settings.lowStockThreshold;

            // PayMob Settings
            if (settings.paymobEnabled !== undefined) {
                document.getElementById('paymobEnabled').checked = settings.paymobEnabled === true || settings.paymobEnabled === 'true';
                updatePaymobStatus();
            }
            if (settings.paymobProduction !== undefined) document.getElementById('paymobProduction').checked = settings.paymobProduction === true || settings.paymobProduction === 'true';
            if (settings.paymobApiKey) document.getElementById('paymobApiKey').value = settings.paymobApiKey;
            if (settings.paymobIntegrationId) document.getElementById('paymobIntegrationId').value = settings.paymobIntegrationId;
            if (settings.paymobIframeId) document.getElementById('paymobIframeId').value = settings.paymobIframeId;
            if (settings.paymobHmacSecret) document.getElementById('paymobHmacSecret').value = settings.paymobHmacSecret;

            // Google Pay Settings
            if (settings.googlePayEnabled !== undefined) {
                document.getElementById('googlePayEnabled').checked = settings.googlePayEnabled === true || settings.googlePayEnabled === 'true';
                updateGooglePayStatus();
            }
            if (settings.googlePayProduction !== undefined) document.getElementById('googlePayProduction').checked = settings.googlePayProduction === true || settings.googlePayProduction === 'true';
            if (settings.googlePayMerchantId) document.getElementById('googlePayMerchantId').value = settings.googlePayMerchantId;
            if (settings.googlePayMerchantName) document.getElementById('googlePayMerchantName').value = settings.googlePayMerchantName;
            if (settings.googlePayGatewayMerchantId) document.getElementById('googlePayGatewayMerchantId').value = settings.googlePayGatewayMerchantId;

            // Apple Pay Settings
            if (settings.applePayEnabled !== undefined) {
                document.getElementById('applePayEnabled').checked = settings.applePayEnabled === true || settings.applePayEnabled === 'true';
                updateApplePayStatus();
            }
            if (settings.applePayProduction !== undefined) document.getElementById('applePayProduction').checked = settings.applePayProduction === true || settings.applePayProduction === 'true';
            if (settings.applePayMerchantId) document.getElementById('applePayMerchantId').value = settings.applePayMerchantId;
            if (settings.applePayMerchantName) document.getElementById('applePayMerchantName').value = settings.applePayMerchantName;

            // COD Settings
            if (settings.codEnabled !== undefined) {
                document.getElementById('codEnabled').checked = settings.codEnabled === true || settings.codEnabled === 'true';
                updateCodStatus();
            }
            if (settings.codFee) document.getElementById('codFee').value = settings.codFee;

            // Shipping Settings
            if (settings.freeShippingEnabled !== undefined) document.getElementById('freeShippingEnabled').checked = settings.freeShippingEnabled === true || settings.freeShippingEnabled === 'true';
            if (settings.freeShippingMinimum) document.getElementById('freeShippingMinimum').value = settings.freeShippingMinimum;
            if (settings.defaultShippingCost) document.getElementById('defaultShippingCost').value = settings.defaultShippingCost;
            if (settings.estimatedDelivery) document.getElementById('estimatedDelivery').value = settings.estimatedDelivery;

            // Tax Settings
            if (settings.taxEnabled !== undefined) document.getElementById('taxEnabled').checked = settings.taxEnabled === true || settings.taxEnabled === 'true';
            if (settings.taxRate) document.getElementById('taxRate').value = settings.taxRate;
            if (settings.taxNumber) document.getElementById('taxNumber').value = settings.taxNumber;

            // Notification Settings
            if (settings.notifyNewOrder !== undefined) document.getElementById('notifyNewOrder').checked = settings.notifyNewOrder === true || settings.notifyNewOrder === 'true';
            if (settings.notifyOrderStatus !== undefined) document.getElementById('notifyOrderStatus').checked = settings.notifyOrderStatus === true || settings.notifyOrderStatus === 'true';
            if (settings.notifyLowStock !== undefined) document.getElementById('notifyLowStock').checked = settings.notifyLowStock === true || settings.notifyLowStock === 'true';
            if (settings.notifyOutOfStock !== undefined) document.getElementById('notifyOutOfStock').checked = settings.notifyOutOfStock === true || settings.notifyOutOfStock === 'true';
            if (settings.adminEmail) document.getElementById('adminEmail').value = settings.adminEmail;
        }

        async function saveAllSettings() {
            showLoading();
            try {
                const settings = {
                    // General
                    appName: document.getElementById('appName').value,
                    appNameAr: document.getElementById('appNameAr').value,
                    supportEmail: document.getElementById('supportEmail').value,
                    supportPhone: document.getElementById('supportPhone').value,
                    defaultCurrency: document.getElementById('defaultCurrency').value,
                    websiteUrl: document.getElementById('websiteUrl').value,

                    // Store
                    storeEnabled: document.getElementById('storeEnabled').checked,
                    allowGuestCheckout: document.getElementById('allowGuestCheckout').checked,
                    minOrderAmount: document.getElementById('minOrderAmount').value,
                    lowStockThreshold: document.getElementById('lowStockThreshold').value,

                    // PayMob
                    paymobEnabled: document.getElementById('paymobEnabled').checked,
                    paymobProduction: document.getElementById('paymobProduction').checked,
                    paymobApiKey: document.getElementById('paymobApiKey').value,
                    paymobIntegrationId: document.getElementById('paymobIntegrationId').value,
                    paymobIframeId: document.getElementById('paymobIframeId').value,
                    paymobHmacSecret: document.getElementById('paymobHmacSecret').value,

                    // Google Pay
                    googlePayEnabled: document.getElementById('googlePayEnabled').checked,
                    googlePayProduction: document.getElementById('googlePayProduction').checked,
                    googlePayMerchantId: document.getElementById('googlePayMerchantId').value,
                    googlePayMerchantName: document.getElementById('googlePayMerchantName').value,
                    googlePayGatewayMerchantId: document.getElementById('googlePayGatewayMerchantId').value,

                    // Apple Pay
                    applePayEnabled: document.getElementById('applePayEnabled').checked,
                    applePayProduction: document.getElementById('applePayProduction').checked,
                    applePayMerchantId: document.getElementById('applePayMerchantId').value,
                    applePayMerchantName: document.getElementById('applePayMerchantName').value,

                    // COD
                    codEnabled: document.getElementById('codEnabled').checked,
                    codFee: document.getElementById('codFee').value,

                    // Shipping
                    freeShippingEnabled: document.getElementById('freeShippingEnabled').checked,
                    freeShippingMinimum: document.getElementById('freeShippingMinimum').value,
                    defaultShippingCost: document.getElementById('defaultShippingCost').value,
                    estimatedDelivery: document.getElementById('estimatedDelivery').value,

                    // Tax
                    taxEnabled: document.getElementById('taxEnabled').checked,
                    taxRate: document.getElementById('taxRate').value,
                    taxNumber: document.getElementById('taxNumber').value,

                    // Notifications
                    notifyNewOrder: document.getElementById('notifyNewOrder').checked,
                    notifyOrderStatus: document.getElementById('notifyOrderStatus').checked,
                    notifyLowStock: document.getElementById('notifyLowStock').checked,
                    notifyOutOfStock: document.getElementById('notifyOutOfStock').checked,
                    adminEmail: document.getElementById('adminEmail').value
                };

                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();

                if (result.success) {
                    showToast('تم حفظ الإعدادات بنجاح', 'success');
                } else {
                    showToast(result.message || 'حدث خطأ أثناء الحفظ', 'danger');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('حدث خطأ في الاتصال', 'danger');
            } finally {
                hideLoading();
            }
        }

        async function testPaymobConnection() {
            const apiKey = document.getElementById('paymobApiKey').value;

            if (!apiKey) {
                showToast('الرجاء إدخال API Key أولاً', 'warning');
                return;
            }

            showLoading();
            try {
                const response = await fetch('https://accept.paymob.com/api/auth/tokens', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ api_key: apiKey })
                });

                if (response.status === 201) {
                    showToast('تم الاتصال بـ PayMob بنجاح!', 'success');
                } else {
                    showToast('فشل الاتصال - تحقق من API Key', 'danger');
                }
            } catch (error) {
                showToast('خطأ في الاتصال بـ PayMob', 'danger');
            } finally {
                hideLoading();
            }
        }

        function updatePaymobStatus() {
            const enabled = document.getElementById('paymobEnabled').checked;
            const status = document.getElementById('paymobStatus');
            status.className = enabled ? 'badge-enabled' : 'badge-disabled';
            status.textContent = enabled ? 'مفعل' : 'معطل';
        }

        function updateGooglePayStatus() {
            const enabled = document.getElementById('googlePayEnabled').checked;
            const status = document.getElementById('googlePayStatus');
            status.className = enabled ? 'badge-enabled' : 'badge-disabled';
            status.textContent = enabled ? 'مفعل' : 'معطل';
        }

        function updateApplePayStatus() {
            const enabled = document.getElementById('applePayEnabled').checked;
            const status = document.getElementById('applePayStatus');
            status.className = enabled ? 'badge-enabled' : 'badge-disabled';
            status.textContent = enabled ? 'مفعل' : 'معطل';
        }

        function updateCodStatus() {
            const enabled = document.getElementById('codEnabled').checked;
            const status = document.getElementById('codStatus');
            status.className = enabled ? 'badge-enabled' : 'badge-disabled';
            status.textContent = enabled ? 'مفعل' : 'معطل';
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const container = document.querySelector('.toast-container');
            const id = 'toast-' + Date.now();

            const icons = {
                success: 'check-circle-fill',
                danger: 'exclamation-triangle-fill',
                warning: 'exclamation-circle-fill',
                info: 'info-circle-fill'
            };

            const toast = document.createElement('div');
            toast.className = `toast show align-items-center text-white bg-${type} border-0`;
            toast.id = id;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${icons[type]} me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.toast').remove()"></button>
                </div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) el.remove();
            }, 5000);
        }
    </script>
</body>
</html>
