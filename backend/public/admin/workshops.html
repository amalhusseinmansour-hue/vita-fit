<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ø´ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .navbar h1 { font-size: 24px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }
        .stat-card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .stat-card h3 { color: #666; font-size: 13px; margin-bottom: 8px; }
        .stat-card .number { font-size: 28px; font-weight: bold; color: #667eea; }

        .header-actions {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }

        .filters { display: flex; gap: 15px; flex-wrap: wrap; }
        .filters input, .filters select { padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; }

        .section {
            background: white; border-radius: 15px; padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .workshops-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .workshop-card {
            border: 1px solid #eee; border-radius: 15px; overflow: hidden;
            transition: all 0.3s;
        }
        .workshop-card:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

        .workshop-image {
            height: 150px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 48px;
        }

        .workshop-body { padding: 20px; }
        .workshop-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .workshop-meta { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .workshop-meta-item {
            display: flex; align-items: center; gap: 5px;
            font-size: 13px; color: #666;
        }
        .workshop-description { color: #666; font-size: 14px; margin-bottom: 15px; line-height: 1.6; }
        .workshop-footer { display: flex; justify-content: space-between; align-items: center; }
        .workshop-price { font-size: 20px; font-weight: bold; color: #667eea; }
        .workshop-actions { display: flex; gap: 8px; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-sm { padding: 8px 15px; font-size: 13px; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #333; }

        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-danger { background: #f8d7da; color: #721c24; }

        .empty-state { text-align: center; padding: 60px; color: #999; }
        .empty-state .icon { font-size: 64px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ø´ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©</h1>
        <div>
            <a href="dashboard">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="products">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
            <a href="orders">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
            <a href="#" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </div>
    </nav>

    <div class="container">
        <div id="alertBox"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ±Ø´</h3>
                <div class="number" id="totalWorkshops">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø§Ù„ÙˆØ±Ø´ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</h3>
                <div class="number" id="upcomingWorkshops">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3>
                <div class="number" id="totalParticipants">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3>
                <div class="number" id="totalRevenue">0</div>
            </div>
        </div>

        <div class="header-actions">
            <div class="filters">
                <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† ÙˆØ±Ø´Ø©..." onkeyup="filterWorkshops()">
                <select id="statusFilter" onchange="filterWorkshops()">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="upcoming">Ù‚Ø§Ø¯Ù…Ø©</option>
                    <option value="ongoing">Ø¬Ø§Ø±ÙŠØ©</option>
                    <option value="completed">Ù…Ù†ØªÙ‡ÙŠØ©</option>
                    <option value="cancelled">Ù…Ù„ØºØ§Ø©</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="openModal()">+ Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ø´Ø©</button>
        </div>

        <div class="section">
            <div id="workshopsContainer" class="workshops-grid"></div>
        </div>
    </div>

    <!-- Workshop Modal -->
    <div id="workshopModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ø´Ø©</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="workshopForm" onsubmit="saveWorkshop(event)">
                    <input type="hidden" id="workshopId">

                    <div class="form-group">
                        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ø´Ø© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
                        <input type="text" id="title" required>
                    </div>

                    <div class="form-group">
                        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ø´Ø© (Ø¹Ø±Ø¨ÙŠ)</label>
                        <input type="text" id="titleAr" required>
                    </div>

                    <div class="form-group">
                        <label>Ø§Ù„ÙˆØµÙ</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ÙˆÙ‚Øª</label>
                            <input type="time" id="time" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                            <input type="number" id="duration" min="30" value="60">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø³Ø¹Ø± (Ø±.Ø³)</label>
                            <input type="number" id="price" step="0.01" value="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</label>
                            <input type="number" id="maxParticipants" min="1" value="20">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø¯Ø±Ø¨</label>
                            <select id="trainerId">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø¨</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ø§Ù„Ù…ÙƒØ§Ù†</label>
                        <input type="text" id="location" placeholder="Ø§Ù„Ù‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© / Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†">
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" style="background: #eee;" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let token = localStorage.getItem('adminToken');
        let workshops = [];
        let trainers = [];

        if (!token) window.location.href = 'index';

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = 'index';
        }

        function showAlert(message, type = 'success') {
            document.getElementById('alertBox').innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => document.getElementById('alertBox').innerHTML = '', 3000);
        }

        async function fetchAPI(endpoint, options = {}) {
            const response = await fetch(`${API_URL}/api${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            return await response.json();
        }

        async function loadTrainers() {
            try {
                const data = await fetchAPI('/trainers');
                if (data.success) {
                    trainers = data.data || [];
                    const select = document.getElementById('trainerId');
                    trainers.forEach(t => {
                        select.innerHTML += `<option value="${t.id}">${t.user?.name || t.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadWorkshops() {
            try {
                const data = await fetchAPI('/workshops');
                if (data.success) {
                    workshops = data.data || [];
                    updateStats();
                    displayWorkshops(workshops);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateStats() {
            document.getElementById('totalWorkshops').textContent = workshops.length;

            const now = new Date();
            const upcoming = workshops.filter(w => new Date(w.date) > now).length;
            document.getElementById('upcomingWorkshops').textContent = upcoming;

            const participants = workshops.reduce((sum, w) => sum + (w.participants_count || 0), 0);
            document.getElementById('totalParticipants').textContent = participants;

            const revenue = workshops.reduce((sum, w) => {
                return sum + (parseFloat(w.price || 0) * (w.participants_count || 0));
            }, 0);
            document.getElementById('totalRevenue').textContent = revenue.toFixed(0);
        }

        function filterWorkshops() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;

            const filtered = workshops.filter(workshop => {
                const matchesSearch = !search ||
                    workshop.title?.toLowerCase().includes(search) ||
                    workshop.title_ar?.includes(search);

                let matchesStatus = true;
                if (status) {
                    const now = new Date();
                    const workshopDate = new Date(workshop.date);

                    if (status === 'upcoming') matchesStatus = workshopDate > now;
                    else if (status === 'completed') matchesStatus = workshopDate < now;
                    else if (status === 'cancelled') matchesStatus = workshop.status === 'cancelled';
                }

                return matchesSearch && matchesStatus;
            });

            displayWorkshops(filtered);
        }

        function displayWorkshops(workshopsList) {
            const container = document.getElementById('workshopsContainer');

            if (workshopsList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="icon">ğŸ“š</div>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ±Ø´ ØªØ¯Ø±ÙŠØ¨ÙŠØ©</p>
                        <button class="btn btn-primary" onclick="openModal()" style="margin-top: 15px;">Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ø´Ø©</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = workshopsList.map(workshop => {
                const workshopDate = new Date(workshop.date);
                const now = new Date();
                const status = workshop.status === 'cancelled' ? 'cancelled' :
                    workshopDate > now ? 'upcoming' : 'completed';

                return `
                    <div class="workshop-card">
                        <div class="workshop-image">ğŸ“š</div>
                        <div class="workshop-body">
                            <div class="workshop-title">${workshop.title_ar || workshop.title}</div>
                            <div class="workshop-meta">
                                <div class="workshop-meta-item">ğŸ“… ${workshopDate.toLocaleDateString('ar')}</div>
                                <div class="workshop-meta-item">â° ${workshop.time || '-'}</div>
                                <div class="workshop-meta-item">â± ${workshop.duration || 60} Ø¯Ù‚ÙŠÙ‚Ø©</div>
                                <div class="workshop-meta-item">ğŸ‘¥ ${workshop.participants_count || 0}/${workshop.max_participants || 20}</div>
                            </div>
                            <div class="workshop-description">${workshop.description || '-'}</div>
                            <div class="workshop-footer">
                                <div>
                                    <span class="workshop-price">${workshop.price || 0} Ø±.Ø³</span>
                                    ${getStatusBadge(status)}
                                </div>
                                <div class="workshop-actions">
                                    <button class="btn btn-sm btn-warning" onclick="editWorkshop(${workshop.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteWorkshop(${workshop.id})">Ø­Ø°Ù</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusBadge(status) {
            const map = {
                'upcoming': { class: 'badge-info', text: 'Ù‚Ø§Ø¯Ù…Ø©' },
                'ongoing': { class: 'badge-success', text: 'Ø¬Ø§Ø±ÙŠØ©' },
                'completed': { class: 'badge-warning', text: 'Ù…Ù†ØªÙ‡ÙŠØ©' },
                'cancelled': { class: 'badge-danger', text: 'Ù…Ù„ØºØ§Ø©' }
            };
            const s = map[status] || { class: 'badge-info', text: status };
            return `<span class="badge ${s.class}">${s.text}</span>`;
        }

        function openModal() {
            document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            document.getElementById('workshopForm').reset();
            document.getElementById('workshopId').value = '';
            document.getElementById('workshopModal').classList.add('active');
        }

        function editWorkshop(id) {
            const workshop = workshops.find(w => w.id === id);
            if (!workshop) return;

            document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ±Ø´Ø©';
            document.getElementById('workshopId').value = workshop.id;
            document.getElementById('title').value = workshop.title || '';
            document.getElementById('titleAr').value = workshop.title_ar || '';
            document.getElementById('description').value = workshop.description || '';
            document.getElementById('date').value = workshop.date?.split('T')[0] || '';
            document.getElementById('time').value = workshop.time || '';
            document.getElementById('duration').value = workshop.duration || 60;
            document.getElementById('price').value = workshop.price || 0;
            document.getElementById('maxParticipants').value = workshop.max_participants || 20;
            document.getElementById('trainerId').value = workshop.trainer_id || '';
            document.getElementById('location').value = workshop.location || '';
            document.getElementById('workshopModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('workshopModal').classList.remove('active');
        }

        async function saveWorkshop(event) {
            event.preventDefault();

            const workshopId = document.getElementById('workshopId').value;
            const workshopData = {
                title: document.getElementById('title').value,
                title_ar: document.getElementById('titleAr').value,
                description: document.getElementById('description').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                duration: document.getElementById('duration').value,
                price: document.getElementById('price').value,
                max_participants: document.getElementById('maxParticipants').value,
                trainer_id: document.getElementById('trainerId').value || null,
                location: document.getElementById('location').value
            };

            try {
                const url = workshopId ? `/workshops/${workshopId}` : '/workshops';
                const method = workshopId ? 'PUT' : 'POST';

                const data = await fetchAPI(url, {
                    method,
                    body: JSON.stringify(workshopData)
                });

                if (data.success) {
                    showAlert(workshopId ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ±Ø´Ø©' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ±Ø´Ø©');
                    closeModal();
                    loadWorkshops();
                } else {
                    showAlert(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'danger');
                }
            } catch (error) {
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ±Ø´Ø©', 'danger');
            }
        }

        async function deleteWorkshop(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ±Ø´Ø©ØŸ')) return;

            try {
                const data = await fetchAPI(`/workshops/${id}`, { method: 'DELETE' });
                if (data.success) {
                    showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ±Ø´Ø©');
                    loadWorkshops();
                } else {
                    showAlert(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'danger');
                }
            } catch (error) {
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ±Ø´Ø©', 'danger');
            }
        }

        loadTrainers();
        loadWorkshops();
    </script>
</body>
</html>
